---
title: "Preles_Verion_Comparison"
author: "Joanna"
date: "2025-01-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing weather data

```{r cars}
weather_preles <- data.table::fread("~/Documents/CASSIA/data/ERAS_dataset_preles.csv")
weather_preles$fAPAR <- 0.7
weather_preles$date <- seq(as.Date("1960-01-01"), as.Date("2022-12-31"), by = "day")
names(weather_preles) <- c("T", "VPD", "PAR", "Rain", "co2", "fAPAR", "date")
```

## Running the models

```{r pressure, echo=FALSE}
preles_original <- Rprebasso::PRELES(weather_preles$PAR,
                                     weather_preles$T,
                                     weather_preles$VPD,
                                     weather_preles$Rain,
                                     weather_preles$CO2,
                                     weather_preles$fAPAR)

preles_CASSIA <- preles_test(processed_data$weather_original)

CASSIA_preles <- CASSIA_cpp(weather = processed_data$weather_original,
                            site = "Hyde",
                            pPREL = c(parameters_all$pPREL, parameters_all$N_parameters),
                            parameters = parameters_all$parameters_test,
                            common = common_p,
                            ratios = ratios_p,
                            sperling = parameters_all$sperling_test,
                            needle_mass_in = parameters_all$needle_mass_in,
                            Throughfall = parameters_all$Throughfall,
                            photosynthesis_as_input = FALSE,
                            preles = TRUE)

CASSIA_preles_ecoevolutionary <- CASSIA_cpp(weather = processed_data$weather_original,
                                            site = "Hyde",
                                            pPREL = c(parameters_all$pPREL, parameters_all$N_parameters),
                                            parameters = parameters_all$parameters_test,
                                            common = common_p,
                                            ratios = ratios_p,
                                            sperling = parameters_all$sperling_test,
                                            needle_mass_in = parameters_all$needle_mass_in,
                                            Throughfall = parameters_all$Throughfall,
                                            photosynthesis_as_input = FALSE,
                                            ecoevolutionary = TRUE)

```

## Model comparison

```{r}
par(mfrow = c(3, 2))
  ylim = c(0, max(c(CASSIA_preles_Xianglin$Preles$GPP, CASSIA_preles$Preles$GPP, preles_CASSIA$GPP)))
  plot(preles_original$GPP, ylab = "GPP", type = "l", ylim = ylim)
  lines(preles_CASSIA$GPP, col = "blue")
  lines(CASSIA_preles$Preles$GPP, col = "purple")
  lines(CASSIA_preles_ecoevolutionary$Preles$GPP, col = "orange")

  ylim = c(0, max(c(preles_CASSIA$GPP, CASSIA_preles_Xianglin$Preles$GPP)))
  plot(preles_original$GPP, preles_CASSIA$GPP, xlab = "Original", ylab = "CASSIA", col = "blue", ylim = ylim)
  points(preles_original$GPP, CASSIA_preles$Preles$GPP, col = "purple")
  points(preles_original$GPP, CASSIA_preles_ecoevolutionary$Preles$GPP, col = "orange")

  ylim = c(0, max(c(preles_CASSIA$ET, CASSIA_preles_Xianglin$Preles$ET)))
  plot(preles_original$ET, ylab = "ET", type = "l", ylim = ylim)
  lines(preles_CASSIA$ET, col = "blue")
  lines(CASSIA_preles$Preles$ET, col = "purple")
  lines(CASSIA_preles_ecoevolutionary$Preles$ET, col = "orange")

  ylim = c(0, max(c(preles_CASSIA$ET, CASSIA_preles_Xianglin$Preles$ET)))
  plot(preles_original$ET, preles_CASSIA$ET, xlab = "Original", ylab = "CASSIA", col = "blue", ylim = ylim)
  points(preles_original$ET, CASSIA_preles$Preles$ET, col = "purple")
  points(preles_original$ET, CASSIA_preles_ecoevolutionary$Preles$ET, col = "orange")

  plot(preles_original$SW, ylab = "Soil Water", type = "l")
  lines(preles_CASSIA$SoilWater, col = "blue")
  lines(CASSIA_preles$Preles$SoilWater, col = "purple")
  lines(CASSIA_preles_ecoevolutionary$Preles$SoilWater, col = "orange")

  plot(preles_original$SW, preles_CASSIA$SoilWater, xlab = "Original", ylab = "CASSIA", col = "blue")
  points(preles_original$SW, CASSIA_preles$Preles$SoilWater, col = "purple")
  points(preles_original$SW, CASSIA_preles_ecoevolutionary$Preles$SoilWater, col = "orange")
  legend("topleft", c("Original", "Preles Wrapper", "Preles in CASSIA", "Xianglin fAPAR"), col = c("black", "blue", "purple", "green"),
         pch = c(2, 2, 2), bty = "n")
```

## Xianglin Effect

TODO: add the documentation for the xianglin effect to make sense

```{r}
CASSIA_preles_Xianglin <- CASSIA_cpp(weather = processed_data$weather_original,
                                       site = "Hyde",
                                       pPREL = c(parameters_all$pPREL, parameters_all$N_parameters),
                                       parameters = parameters_all$parameters_test,
                                       common = common_p,
                                       ratios = ratios_p,
                                       sperling = parameters_all$sperling_test,
                                       needle_mass_in = parameters_all$needle_mass_in,
                                       Throughfall = parameters_all$Throughfall,
                                       photosynthesis_as_input = FALSE,
                                       fAPAR_Tian = TRUE)

  CASSIA_preles_ecoevolutionary_Xianglin <- CASSIA_cpp(weather = processed_data$weather_original,
                                                       site = "Hyde",
                                                       pPREL = c(parameters_all$pPREL, parameters_all$N_parameters),
                                                       parameters = parameters_all$parameters_test,
                                                       common = common_p,
                                                       ratios = ratios_p,
                                                       sperling = parameters_all$sperling_test,
                                                       needle_mass_in = parameters_all$needle_mass_in,
                                                       Throughfall = parameters_all$Throughfall,
                                                       photosynthesis_as_input = FALSE,
                                                       ecoevolutionary = TRUE,
                                                       fAPAR_Tian = TRUE)
```

