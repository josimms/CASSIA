---
title: "optimisation_try"
output: html_document
---

```{r}
library(Rsolnp)
library(ggplot2)
library(reshape2)
```

### Original optimisation

```{r}
library(Rsolnp)

# Parameters
N_r <- 10
N_m <- 100
epsilon <- 1e-6
beta_m <- 0.1
N_T <- 8
c_I <- 5

# Nitrogen function
N_fun <- function(c) {
  c_s <- c[1]; c_m <- c[2]
  (c_s / (c_s + c_m + epsilon)) * N_r +
    (c_m / (c_m + beta_m)) * N_m
}

# Step 1: Try to meet target N_T (same as your original)
objective_min_sugar <- function(c) sum(c)

eq_constraint <- function(c) N_fun(c) - N_T
ineq_constraint <- function(c) c_I - sum(c)

init <- c(0.1, 0.1)
res1 <- try(
  solnp(pars = init,
        fun = objective_min_sugar,
        eqfun = eq_constraint,
        eqB = 0,
        ineqfun = ineq_constraint,
        ineqLB = 0,
        ineqUB = Inf,
        LB = c(0,0),
        UB = c(c_I, c_I)),
  silent = TRUE
)

if (!inherits(res1, "try-error") && abs(N_fun(res1$pars) - N_T) < 1e-4) {
  # Feasible solution found
  c_opt <- res1$pars
  mode <- "Target N_T achieved by minimizing sugar."
} else {
  # Step 2: Maximize N if N_T is infeasible
  res2 <- solnp(
    pars = init,
    fun = function(c) -N_fun(c),             # maximize N
    ineqfun = ineq_constraint,
    ineqLB = 0,
    ineqUB = Inf,
    LB = c(0,0),
    UB = c(c_I, c_I)
  )
  c_opt <- res2$pars
  mode <- "Target N_T NOT achievable. Maximized N instead."
}

cat(mode, "\n")
cat("Optimal c_s =", c_opt[1], "\n")
cat("Optimal c_m =", c_opt[2], "\n")
cat("Total sugar =", sum(c_opt), "\n")
cat("Achieved N =", N_fun(c_opt), "\n")


```

### Visulisation of the N_r and N_m parameter's effect on the solution

```{r}
epsilon <- 1e-6
beta_m <- 0.1
N_T <- 8
c_I <- 5

N_r_vals <- seq(0, 10, length.out = 50)
N_m_vals <- seq(0, 10, length.out = 50)
grid <- expand.grid(N_r = N_r_vals, N_m = N_m_vals)

grid$c_s_opt <- NA
grid$c_m_opt <- NA

c_m_seq <- seq(0, c_I, length.out = 500)  # finer scan for accuracy

for(i in 1:nrow(grid)) {
  N_r_i <- grid$N_r[i]
  N_m_i <- grid$N_m[i]
  
  feasible <- data.frame(c_s = numeric(0), c_m = numeric(0))
  
  for(c_m in c_m_seq) {
    term2 <- (c_m / (c_m + beta_m)) * N_m_i
    if(N_r_i == 0) {
      if(abs(term2 - N_T) < 1e-6) c_s <- 0 else next
    } else {
      c_s <- (N_T - term2) * (c_m + epsilon) / (N_r_i - (N_T - term2))
    }
    
    if(is.na(c_s) || c_s < 0) next
    if(c_s + c_m > c_I) next
    
    feasible <- rbind(feasible, data.frame(c_s = c_s, c_m = c_m))
  }
  
  if(nrow(feasible) > 0) {
    # Example: pick pair minimizing total c_s + c_m
    best_idx <- which.min(feasible$c_s + feasible$c_m)
    grid$c_s_opt[i] <- feasible$c_s[best_idx]
    grid$c_m_opt[i] <- feasible$c_m[best_idx]
  } else {
    grid$c_s_opt[i] <- NA
    grid$c_m_opt[i] <- NA
  }
}

# Heatmaps
library(ggplot2)
library(reshape2)
library(viridis)

c_s_melt <- melt(grid, id.vars = c("N_r", "N_m"), measure.vars = "c_s_opt")
c_m_melt <- melt(grid, id.vars = c("N_r", "N_m"), measure.vars = "c_m_opt")

library(gridExtra)

p1 <- ggplot(c_s_melt, aes(x = N_r, y = N_m, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", na.value = "white") +
  labs(title = "Optimal c_s", x = "N_r", y = "N_m", fill = "c_s") +
  theme_minimal()

p2 <- ggplot(c_m_melt, aes(x = N_r, y = N_m, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", na.value = "white") +
  labs(title = "Optimal c_m", x = "N_r", y = "N_m", fill = "c_m") +
  theme_minimal()

grid.arrange(p1, p2, ncol = 2)


```

```{r}

epsilon <- 1e-6
beta_m <- 01
N_T <- 8
c_I <- 5

N_r_vals <- seq(0, 10, length.out = 50)
N_m_vals <- seq(0, 10, length.out = 50)
grid <- expand.grid(N_r = N_r_vals, N_m = N_m_vals)

grid$c_s_opt <- NA
grid$c_m_opt <- NA
grid$N_achieved <- NA  # store final N achieved

c_m_seq <- seq(0, c_I, length.out = 500)

for(i in 1:nrow(grid)) {
  N_r_i <- grid$N_r[i]
  N_m_i <- grid$N_m[i]
  
  feasible <- data.frame(c_s = numeric(0), c_m = numeric(0))
  
  for(c_m in c_m_seq) {
    term2 <- (c_m / (c_m + beta_m)) * N_m_i
    if(N_r_i == 0) {
      if(abs(term2 - N_T) < 1e-6) c_s <- 0 else next
    } else {
      c_s <- (N_T - term2) * (c_m + epsilon) / (N_r_i - (N_T - term2))
    }
    if(is.na(c_s) || c_s < 0) next
    if(c_s + c_m > c_I) next
    feasible <- rbind(feasible, data.frame(c_s = c_s, c_m = c_m))
  }
  
  if(nrow(feasible) > 0) {
    # ✅ Target N_T feasible → minimize total carbon
    best_idx <- which.min(feasible$c_s + feasible$c_m)
    c_s_opt <- feasible$c_s[best_idx]
    c_m_opt <- feasible$c_m[best_idx]
    N_final <- N_T
  } else {
    # ❗ Not feasible → maximize achievable nitrogen
    bestN <- -Inf
    best_c_s <- NA
    best_c_m <- NA
    
    for(c_m in c_m_seq) {
      max_c_s <- c_I - c_m
      if(max_c_s < 0) next
      N_try <- (max_c_s / (max_c_s + c_m + epsilon)) * N_r_i +
               (c_m / (c_m + beta_m)) * N_m_i
      if(N_try > bestN) {
        bestN <- N_try
        best_c_s <- max_c_s
        best_c_m <- c_m
      }
    }
    c_s_opt <- best_c_s
    c_m_opt <- best_c_m
    N_final <- bestN
  }
  
  grid$c_s_opt[i] <- c_s_opt
  grid$c_m_opt[i] <- c_m_opt
  grid$N_achieved[i] <- N_final
}

# Heatmaps -----------------------------------
library(ggplot2)
library(reshape2)
library(viridis)
library(gridExtra)

c_s_melt <- melt(grid, id.vars = c("N_r", "N_m"), measure.vars = "c_s_opt")
c_m_melt <- melt(grid, id.vars = c("N_r", "N_m"), measure.vars = "c_m_opt")

p1 <- ggplot(c_s_melt, aes(x = N_r, y = N_m, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", na.value = "white") +
  labs(title = "Optimal c_s", x = "N_r", y = "N_m", fill = "c_s") +
  theme_minimal()

p2 <- ggplot(c_m_melt, aes(x = N_r, y = N_m, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", na.value = "white") +
  labs(title = "Optimal c_m", x = "N_r", y = "N_m", fill = "c_m") +
  theme_minimal()

grid.arrange(p1, p2, ncol = 2)


```
