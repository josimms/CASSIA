# Running the Model

## Inport libraries

First, download the package from github.

```{r}
library(devtools)
# install_github("josimms/CASSIA")
library(CASSIA)
```

## Run the model

The model has automatic settings which produces the results as in the 2015 paper in Hyytiälä. The parameters and input weather for Hyytiälä are automatically included in the package.

```{r}
# Get the weather data
weather_original <- read_and_combine_weather_data(2015, 2018, base_path = "~/Documents/CASSIA/data/weather_original_")
# TODO: change the path to your path. Data is found in ./data in the package
weather_original$date <- as.Date(strptime(paste(rep(2015:2018, times = c(365, 366, 365, 365)), weather_original$X), format = "%Y %j"))

# Run the model
out = CASSIA_cpp(weather = weather_original, site = "Hyde")
```

The model has a list datasets for the output. These are for the growth, sugar model and preles (photosynthesis model) respectively.

The original model or basic settings mainly has results in the Growth database.

```{r}
head(out$Growth)
```

The other settings of the model an be accessed by the function argument switches. These settings can be found in the help function for the CASSIA model. 

The following example means that the trees growth, so that the model uses the previous year's growth as the initial conditions for the next year.

```{r}
out2 = CASSIA_cpp(weather_original, site = "Hyde", LN_estim = TRUE)

# To ccheck the possible options
?CASSIA
```

To change the parameters they must be in a table form as the preloaded ratios_p, parameters_p, common_p. sperling_p and repo_p. The easiest way of doing this could be to redefine the parameters from the default objects.

The meaning of the parameters can be found in the CASSIA instruction booklet.

```{r}
parameters_updated <- parameters_p # This step is important so the default values aren't overwritten
parameters_updated[c("root.lifetime	"),c("Hyde")] <- 2

out3 = CASSIA_cpp(weather_original, site = "Hyde", parameters = parameters_updated)
```

Finally, the weather data should be considered. Due to the linking with different photosynthesis models the weather needed in the model currently takes three forms.

The data needed per dataset is listed below with the units and examples of this data for Hyyitälä is included in the package and are printed below.

Note the toggles can be a bit confusing for the weather.

| Model    | Explanation                                                                    | photosynthesis_as_input | preles | phydro | fAPAR_Tian |
|----------|--------------------------------------------------------------------------------|--------------------------|--------|--------|------------|
| SPP      | SPP isn't calculated within the model so could be replaced with another input | TRUE                     | FALSE  | FALSE  | FALSE      |
| Preles   | Preles is calculated within the model but the leaf area can be changed         | FALSE                    | TRUE   | FALSE  | FALSE or TRUE |
| Phydro   | Phydro is calculated within the model per leaf area                            | FALSE                    | FALSE  | TRUE   | FALSE      |


```{r}
head(weather_original)

# TODO: add the preles data

# TODO: add the phydro data
```
