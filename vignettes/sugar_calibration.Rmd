---
title: "sugar_calibration"
output: html_document
---

```{r}
library(parallel)
library(DEoptim)
library(CASSIA)
```

# Set up the initial conditions

```{r}
data_directory <- "~/Documents/CASSIA_Calibration/Processed_Data/"
loaded_data <- load_data(data_directory)

new_parameters <- rep(0.5, 27)  # Example new parameters
calibration = F
parameters_2015 <- initialize_parameters(calibration, new_parameters)

parameters_2015$parameters_test[c("h0"),c("Hyde")] <- 12
parameters_2015$parameters_test[c("D0"),c("Hyde")] <- 0.1416 # TODO: check units, but value from data
parameters_2015$parameters_test[c("GPP_mean"),c("Hyde")] <- 463.8833
parameters_2015$parameters_test[c("GPP_initial"),c("Hyde")] <- 460.0

parameters_2015$sperling_test[c("Wala.needles"), c("Hyde")] <- min(loaded_data$original_data$needles_sugar, na.rm = T)
parameters_2015$sperling_test[c("Wala.phloem"), c("Hyde")] <- min(loaded_data$original_data$phloem_sugar, na.rm = T)
parameters_2015$sperling_test[c("Wala.roots"), c("Hyde")] <- min(loaded_data$original_data$roots_sugar, na.rm = T)
parameters_2015$sperling_test[c("Wala.xylem_sh"), c("Hyde")] <- min(loaded_data$original_data$xylem_sh_sugar, na.rm = T)
parameters_2015$sperling_test[c("Wala.xylem_st"), c("Hyde")] <- min(loaded_data$original_data$xylem_st_sugar, na.rm = T)

# sugar0: initial conditions, don't need to parameterise
# starch0: initial conditions, don't need to parameterise
parameters_2015$sperling_test[c("starch.needles0"), c("Hyde")] <- loaded_data$original_data$needles_starch[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("starch.phloem0"), c("Hyde")] <- loaded_data$original_data$phloem_starch[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("starch.roots0"), c("Hyde")] <- loaded_data$original_data$roots_starch[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("starch.xylem.sh0"), c("Hyde")] <- loaded_data$original_data$xylem_sh_starch[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("starch.xylem.st0"), c("Hyde")] <- loaded_data$original_data$xylem_st_starch[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("sugar.needles0"), c("Hyde")] <- loaded_data$original_data$needles_sugar[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("sugar.phloem0"), c("Hyde")] <- loaded_data$original_data$phloem_sugar[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("sugar.roots0"), c("Hyde")] <- loaded_data$original_data$roots_sugar[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("sugar.xylem.sh0"), c("Hyde")] <- loaded_data$original_data$xylem_sh_sugar[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]
parameters_2015$sperling_test[c("sugar.xylem.st0"), c("Hyde")] <- loaded_data$original_data$xylem_st_sugar[rownames(loaded_data$original_data) %in% as.Date("2015-03-17")]

time_of_calibration <- 1:13

validate_sugar <- c(
  loaded_data$original_data$needles_sugar[time_of_calibration], 
  loaded_data$original_data$needles_starch[time_of_calibration],
  loaded_data$original_data$phloem_sugar[time_of_calibration], 
  loaded_data$original_data$phloem_starch[time_of_calibration],
  loaded_data$original_data$roots_sugar[time_of_calibration], 
  loaded_data$original_data$roots_starch[time_of_calibration],
  loaded_data$original_data$xylem_sh_sugar[time_of_calibration], 
  loaded_data$original_data$xylem_sh_starch[time_of_calibration],
  loaded_data$original_data$xylem_st_sugar[time_of_calibration],
  loaded_data$original_data$xylem_st_starch[time_of_calibration]
  )

# Detect available cores
ncores <- detectCores() - 1  # Leave one core free

# Precompute weather & autumn indices once
weather_preles <- data.table::fread("~/Documents/CASSIA/data/ERA5_CASSIA_preles.csv")
weather_2015 <- weather_preles[weather_preles$date >= as.Date("2015-01-01") & weather_preles$date <= as.Date("2015-12-31"), ]
weather_1998_2022 <- weather_preles[weather_preles$date >= as.Date("1998-01-01") & weather_preles$date <= as.Date("2022-12-31"), ]

dates_2015 <- seq(as.Date("2015-01-01"), as.Date("2015-12-31"), by = "day")
autumn <- as.Date(rownames(loaded_data$original_data))[time_of_calibration]
autumn_indices <- which(dates_2015 %in% autumn)
```

# No Sugar Model

```{r}
parameters_2015$sperling_test[c("sugar00"), c("Hyde")] <- 0.42
CASSIA_preles_1998_2022_sugar_medium <- CASSIA_cpp(weather = weather_preles_1998_2022,
                                                site = "Hyde",
                                                pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
                                                parameters = parameters_2015$parameters_test,
                                                common = common_p,
                                                ratios = ratios_p,
                                                sperling = parameters_2015$sperling_test,
                                                needle_mass_in = parameters_2015$needle_mass_in,
                                                Throughfall = parameters_2015$Throughfall,
                                                photosynthesis_as_input = FALSE,
                                                preles = TRUE,
                                                fAPAR_Tian = TRUE)

parameters_2015$sperling_test[c("sugar00"), c("Hyde")] <- 0.1
CASSIA_preles_1998_2022_sugar_low <- CASSIA_cpp(weather = weather_preles_1998_2022,
                                                site = "Hyde",
                                                pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
                                                parameters = parameters_2015$parameters_test,
                                                common = common_p,
                                                ratios = ratios_p,
                                                sperling = parameters_2015$sperling_test,
                                                needle_mass_in = parameters_2015$needle_mass_in,
                                                Throughfall = parameters_2015$Throughfall,
                                                photosynthesis_as_input = FALSE,
                                                preles = TRUE,
                                                fAPAR_Tian = TRUE)

parameters_2015$sperling_test[c("sugar00"), c("Hyde")] <- 0.75
CASSIA_preles_1998_2022_sugar_high <- CASSIA_cpp(weather = weather_preles_1998_2022,
                                                site = "Hyde",
                                                pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
                                                parameters = parameters_2015$parameters_test,
                                                common = common_p,
                                                ratios = ratios_p,
                                                sperling = parameters_2015$sperling_test,
                                                needle_mass_in = parameters_2015$needle_mass_in,
                                                Throughfall = parameters_2015$Throughfall,
                                                photosynthesis_as_input = FALSE,
                                                preles = TRUE,
                                                fAPAR_Tian = TRUE)

```


# Calibration

```{r}
objective_function <- function(par) {
  names(par) <- c(
    "Ad0.needles", "lamda.needles", "delta.needles",
    "Ad0.phloem",  "lamda.phloem",  "delta.phloem",
    "Ad0.roots",   "lamda.roots",   "delta.roots",
    "Ad0.xylem.sh","lamda.xylem.sh","delta.xylem.sh",
    "Ad0.xylem.st","lamda.xylem.st","delta.xylem.st",
    "myco.thresh",
    "percentage_needle_storage", "percentage_phloem_storage", 
    "percentage_xylem_sh_storage", "percentage_xylem_st_storage", 
    "percentage_roots_storage"
  )

  # Update parameters
  sperling_test_local <- parameters_2015$sperling_test
  sperling_test_local[names(par), "Hyde"] <- par

  tryCatch({
    model_output <- CASSIA_cpp(
      weather = weather_2015,
      site = "Hyde",
      pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
      parameters = parameters_2015$parameters_test,
      common = common_p,
      ratios = ratios_p,
      sperling = sperling_test_local,  # Only small object passed
      needle_mass_in = parameters_2015$needle_mass_in,
      Throughfall = parameters_2015$Throughfall,
      photosynthesis_as_input = FALSE,
      preles = TRUE,
      fAPAR_Tian = TRUE,
      sperling_model = TRUE
    )
    
    # Check if model output has any non-finite values (NA, Inf, NaN)
    model_values <- c(
      model_output$Sugar$sugar_needles[autumn_indices],
      model_output$Sugar$starch_needles[autumn_indices],
      model_output$Sugar$sugar_phloem[autumn_indices],
      model_output$Sugar$starch_phloem[autumn_indices],
      model_output$Sugar$sugar_roots[autumn_indices],
      model_output$Sugar$starch_roots[autumn_indices],
      model_output$Sugar$sugar_xylem.sh[autumn_indices],
      model_output$Sugar$starch_xylem.sh[autumn_indices],
      model_output$Sugar$sugar_xylem.st[autumn_indices],
      model_output$Sugar$starch_xylem.st[autumn_indices]
    )

    # If any values are NA, Inf, or NaN, return a large penalty
    if (any(is.na(model_values) | is.infinite(model_values) | (sum(!model_output$Culm_Growth$tree_alive) > 0))) {
      return(1e10)  # Return a large penalty for invalid runs
    }

    # Calculate error
    error <- sqrt(mean((model_values - validate_sugar)^2, na.rm = TRUE))
    
    return(error)
  }, error = function(e) {
    # Catch errors during model execution and return a large penalty
    message("Error in model execution: ", e)
    return(1e10)  # Return a large penalty if an error occurs
  })
}

# Initial parameter guess
initial_guess <- c(
  # Ezymes
  0.438024, 0.002, 0.05,   # needles
  0.608733, 0.001, 0.01,   # phloem
  0.790206, 0.002, 0.05,   # roots
  0.7712,   0.002, 0.05,   # xylem.sh
  0.768777, 0.002, 0.05,   # xylem.st
  0.3,                      # myco.thresh in roots
  # Storage Capacity of each organ
  0.11, 0.11, 0.2, 0.2, 0.11
)

# Set up parallel cluster
ncores <- detectCores() - 1  # Leave 1 core free
cl <- makeCluster(ncores)

# Load libraries on workers
clusterEvalQ(cl, {
  library(CASSIA)  # Replace with your package name if needed
})

# Export necessary objects
clusterExport(cl, varlist = c(
  "CASSIA_cpp", "parameters_2015", "weather_2015",
  "validate_sugar", "common_p", "ratios_p",
  "objective_function", "autumn_indices"
))

# Aseta parametrien ala- ja ylärajat
lower_bounds <- rep(0, length(initial_guess))  # Esim. kaikki parametrit ≥ 0
upper_bounds <- rep(1, length(initial_guess)) # Max-arvot, säädä tarpeen mukaan

# Optimointi DEoptimilla
fit <- DEoptim(
  fn = objective_function,     # Sun virhefunktio
  lower = lower_bounds,        # Alarajat
  upper = upper_bounds,        # Ylärajat
  control = DEoptim.control(
    itermax = 200,             # Iteraatioiden määrä, lisää jos haluat tarkkuutta
    parallelType = 1,          # Hyödyntää clusteria jos käytössä
    cluster = cl,
    trace = TRUE               # Tulostaa edistymistä
  )
)

# Tulosteet
print(fit$optim$bestval)  # Paras löydetty virhe
print(fit$optim$bestmem)  # Parhaat parametrit
```

# Run the model for the year of the calibration and the steady state Hyytiälä

```{r}
names(fit$optim$bestmem) <- c("Ad0.needles", "lamda.needles", "delta.needles",
    "Ad0.phloem",  "lamda.phloem",  "delta.phloem",
    "Ad0.roots",   "lamda.roots",   "delta.roots",
    "Ad0.xylem.sh","lamda.xylem.sh","delta.xylem.sh",
    "Ad0.xylem.st","lamda.xylem.st","delta.xylem.st",
    "myco.thresh",
    "percentage_needle_storage", "percentage_phloem_storage", 
    "percentage_xylem_sh_storage", "percentage_xylem_st_storage", 
    "percentage_roots_storage")

# Update parameters
parameters_2015$sperling_test[names(fit$optim$bestmem), "Hyde"] <- fit$optim$bestmem


CASSIA_preles_2015 <- CASSIA_cpp(
    weather = weather_2015,
    site = "Hyde",
    pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
    parameters = parameters_2015$parameters_test,
    common = common_p,
    ratios = ratios_p,
    sperling = parameters_2015$sperling_test,
    needle_mass_in = parameters_2015$needle_mass_in,
    Throughfall = parameters_2015$Throughfall,
    photosynthesis_as_input = FALSE,
    preles = TRUE,
    fAPAR_Tian = TRUE,
    sperling_model = TRUE
  )

CASSIA_preles_1998_2022 <- CASSIA_cpp(
    weather = weather_1998_2022,
    site = "Hyde",
    pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
    parameters = parameters_2015$parameters_test,
    common = common_p,
    ratios = ratios_p,
    sperling = parameters_2015$sperling_test,
    needle_mass_in = parameters_2015$needle_mass_in,
    Throughfall = parameters_2015$Throughfall,
    photosynthesis_as_input = FALSE,
    preles = TRUE,
    fAPAR_Tian = TRUE,
    sperling_model = TRUE
  )
```

# Plot for a year

```{r}
###
# Yearly view
###

ylim = range(0, CASSIA_preles_2015$Sugar$sugar_needles, CASSIA_preles_2015$Sugar$sugar_phloem, CASSIA_preles_2015$Sugar$sugar_xylem_sh, CASSIA_preles_2015$Sugar$sugar_xylem_st, CASSIA_preles_2015$Sugar$sugar_roots, na.rm = T)
if (is.infinite(ylim[2])) {
  ylim[2] = 1
}
par(mfrow = c(1, 2))
plot(dates_2015, CASSIA_preles_2015$Sugar$sugar_needles, type = "l", col = "green", ylim = ylim, main = "Sugar (all organs)", ylab = "Sugar", xlab = "Date")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$needles_sugar, col = "green")
lines(dates_2015, CASSIA_preles_2015$Sugar$sugar_phloem, type = "l", col = "brown")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$phloem_sugar, col = "brown")
lines(dates_2015, CASSIA_preles_2015$Sugar$sugar_xylem_sh, type = "l", col = "red")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_sh_sugar, col = "red")
lines(dates_2015, CASSIA_preles_2015$Sugar$sugar_xylem_st, type = "l", col = "gold")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_st_sugar, col = "gold")
lines(dates_2015, CASSIA_preles_2015$Sugar$sugar_roots, type = "l", col = "black")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$roots_sugar, col = "black")
legend("topleft", c("Needles", "Phloem", "Xylem Sh", "Xylem St", "Roots"), col = c("green", "brown", "red", "gold", "black"), lty = 1, bty = "n", cex = 0.75)

# CASSIA_preles_2015$Sugar$starch_xylem_sh
ylim = range(0, CASSIA_preles_2015$Sugar$starch_needles, CASSIA_preles_2015$Sugar$starch_phloem, CASSIA_preles_2015$Sugar$starch_xylem_st, CASSIA_preles_2015$Sugar$starch_roots, CASSIA_preles_2015$Sugar$starch_xylem_sh, na.rm = T)
plot(dates_2015, CASSIA_preles_2015$Sugar$starch_needles, type = "l", col = "green", ylim = ylim, main = "Starch (all organs)", ylab = "Starch", xlab = "Date")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$needles_starch, col = "green")
lines(dates_2015, CASSIA_preles_2015$Sugar$starch_phloem, type = "l", col = "brown")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$phloem_starch, col = "brown")
lines(dates_2015, CASSIA_preles_2015$Sugar$starch_xylem_sh, type = "l", col = "red")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_sh_starch, col = "red")
lines(dates_2015, CASSIA_preles_2015$Sugar$starch_xylem_st, type = "l", col = "gold")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_st_starch, col = "gold")
lines(dates_2015, CASSIA_preles_2015$Sugar$starch_roots, type = "l", col = "black")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$roots_starch, col = "black")

###
# Long time graphs
###

dates = as.Date(paste0(CASSIA_preles_1998_2022$Growth$year, CASSIA_preles_1998_2022$Growth$day), format = "%Y %j")

ylim = range(0, CASSIA_preles_1998_2022$Sugar$sugar_needles, 
             CASSIA_preles_1998_2022$Sugar$sugar_phloem, 
             CASSIA_preles_1998_2022$Sugar$sugar_xylem_sh, 
             CASSIA_preles_1998_2022$Sugar$sugar_xylem_st, 
             CASSIA_preles_1998_2022$Sugar$sugar_roots, na.rm = T)
if (is.infinite(ylim[2])) {
  ylim[2] = 1
}
par(mfrow = c(1, 2))
plot(dates, CASSIA_preles_1998_2022$Sugar$sugar_needles, type = "l", col = "green", ylim = ylim, main = "Sugar (all organs)", ylab = "Sugar", xlab = "Date")
lines(dates, CASSIA_preles_1998_2022$Sugar$sugar_phloem, type = "l", col = "brown")
lines(dates, CASSIA_preles_1998_2022$Sugar$sugar_xylem_sh, type = "l", col = "red")
lines(dates, CASSIA_preles_1998_2022$Sugar$sugar_xylem_st, type = "l", col = "gold")
lines(dates, CASSIA_preles_1998_2022$Sugar$sugar_roots, type = "l", col = "black")

ylim = range(0, CASSIA_preles_1998_2022$Sugar$starch_needles, CASSIA_preles_1998_2022$Sugar$starch_phloem, CASSIA_preles_1998_2022$Sugar$starch_xylem_sh, CASSIA_preles_1998_2022$Sugar$starch_xylem_st, CASSIA_preles_1998_2022$Sugar$starch_roots, na.rm = T)
if (is.infinite(ylim[2])) {
  ylim[2] = 1
}
plot(dates, CASSIA_preles_1998_2022$Sugar$starch_needles, type = "l", col = "green", ylim = ylim, main = "Starch (all organs)", ylab = "Starch", xlab = "Date")
lines(dates, CASSIA_preles_1998_2022$Sugar$starch_phloem, type = "l", col = "brown")
lines(dates, CASSIA_preles_1998_2022$Sugar$starch_xylem_sh, type = "l", col = "red")
lines(dates, CASSIA_preles_1998_2022$Sugar$starch_xylem_st, type = "l", col = "gold")
lines(dates, CASSIA_preles_1998_2022$Sugar$starch_roots, type = "l", col = "black")
```

# Import biomass data

```{r}
height = loaded_data$smearII_data$variable %in% c("dominant_height") | 
  loaded_data$smearII_data$variable %in% c("pine height BA weighted mean") |
  loaded_data$smearII_data$variable %in% c("pine height arithmetic mean") |
  loaded_data$smearII_data$variable %in% c("tree_height_baseal_area_weighted_mean")

height_df <- loaded_data$smearII_data[height,]

height_cl = loaded_data$smearII_data$variable %in% c("pine CrownL arithmetic mean") | 
  loaded_data$smearII_data$variable %in% c("BA weighted mean CrownL pine") |
  loaded_data$smearII_data$variable %in% c("Arithmetic mean CrownL pine") |
  loaded_data$smearII_data$variable %in% c("pine CrownL BA weighted mean") |
  loaded_data$smearII_data$variable %in% c("pine CrownL arithmetic mean")

height_cl_df <- loaded_data$smearII_data[height_cl,]

diameter = loaded_data$smearII_data$variable %in% c("BA weighted mean DBH pine") | 
  loaded_data$smearII_data$variable %in% c("Arithmetic mean DBH pine") |
  loaded_data$smearII_data$variable %in% c("pine DBH arithmetic mean") |
  loaded_data$smearII_data$variable %in% c("pine diameter BA weighted mean")

diameter_df <- loaded_data$smearII_data[diameter,]

LAI = loaded_data$smearII_data$variable %in% c("LAI_pine_allsided") | 
  loaded_data$smearII_data$variable %in% c("LAI_pine_ICOS")

LAI_df <- loaded_data$smearII_data[LAI,]

foliage_biomass = loaded_data$smearII_data$variable %in% c("pine_foliage_biomass") | 
  loaded_data$smearII_data$variable %in% c("pine_foliage_biomass_ICOS") |
  loaded_data$smearII_data$variable %in% c("Needles / Leaves before thinning") |
  loaded_data$smearII_data$variable %in% c("Needles / Leaves after thinning") |
  loaded_data$smearII_data$variable %in% c("Needles / Leaves removed in thinning")

foliage_biomass_df <- loaded_data$smearII_data[foliage_biomass,]


branches = loaded_data$smearII_data$variable %in% c("Living branches before thinning") | 
  loaded_data$smearII_data$variable %in% c("Living branches after thinning")

branches_df <- loaded_data$smearII_data[branches,]
```

# Original Sugar Model Comparison

```{r}
# Sugar, Starch
ylim = range(c(0, max(CASSIA_preles_1998_2022_sugar_high$Sugar$sugar, CASSIA_preles_1998_2022$Sugar$sugar, na.rm = T)))
if (is.infinite(ylim[2])) {
  ylim[2] = 1
}
par(mfrow = c(1, 2))
plot(dates, CASSIA_preles_1998_2022_sugar_low$Sugar$sugar, type = "l", col = "red", ylab = "Sugar", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_sugar_medium$Sugar$sugar, col = "gold")
lines(dates, CASSIA_preles_1998_2022$Sugar$sugar, col = "green")
lines(dates, CASSIA_preles_1998_2022_sugar_high$Sugar$sugar, col = "blue")

ylim = range(c(0, CASSIA_preles_1998_2022_sugar_medium$Sugar$starch, CASSIA_preles_1998_2022_sugar_low$Sugar$starch, CASSIA_preles_1998_2022$Sugar$starch, CASSIA_preles_1998_2022_sugar_high$Sugar$starch))
plot(dates, CASSIA_preles_1998_2022_sugar_medium$Sugar$starch, type = "l", col = "gold", ylab = "Starch", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_sugar_low$Sugar$starch, col = "red")
lines(dates, CASSIA_preles_1998_2022$Sugar$starch, col = "green")
lines(dates, CASSIA_preles_1998_2022_sugar_high$Sugar$starch, col = "blue")

# Storage term
par(mfrow = c(1, 2))
plot(dates, CASSIA_preles_1998_2022_sugar_low$Sugar$storage, type = "l", col = "red", ylab = "Storage term", xlab = "Years", ylim = c(0, 1))
lines(dates, CASSIA_preles_1998_2022_sugar_medium$Sugar$storage, col = "gold")
lines(dates, (CASSIA_preles_1998_2022$Sugar$storage)/5, col = "green")
lines(dates, CASSIA_preles_1998_2022_sugar_high$Sugar$storage_term, col = "blue")
legend("bottomright", c("High", "Medium", "Low", "My Model"), col = c("blue", "gold", "red", "green"), lty = 1, bty = "n")

plot(dates, CASSIA_preles_1998_2022$Sugar$storage_term_roots, col = "black", type = "l", main = "Storage Term for each organ", xlab = "Years", ylim = c(0, 1), ylab = "Storage term")
lines(dates, CASSIA_preles_1998_2022$Sugar$storage_term_phloem, col = "brown")
lines(dates, CASSIA_preles_1998_2022$Sugar$storage_term_needles, col = "green")
lines(dates, CASSIA_preles_1998_2022$Sugar$storage_term_xylem_sh, col = "red")
lines(dates, CASSIA_preles_1998_2022$Sugar$storage_term_xylem_st, col = "gold")

# Seasonal, growth
par(mfrow = c(1, 2))
plot(dates, CASSIA_preles_1998_2022_sugar_low$Growth$height_growth, type = "l", col = "red", ylab = "Height", xlab = "Years", ylim = c(0, max(CASSIA_preles_1998_2022_sugar_high$Growth$height_growth, CASSIA_preles_1998_2022$Growth$height_growth, na.rm = TRUE)))
lines(dates, CASSIA_preles_1998_2022_sugar_high$Growth$height_growth, col = "blue")
lines(dates, CASSIA_preles_1998_2022$Growth$height_growth, col = "green")
lines(dates, CASSIA_preles_1998_2022_sugar_medium$Growth$height_growth, col = "gold")

plot(dates, CASSIA_preles_1998_2022_sugar_low$Growth$diameter_growth, type = "l", col = "red", ylab = "Diameter", xlab = "Years", ylim = c(0, 1))
lines(dates, CASSIA_preles_1998_2022_sugar_high$Growth$diameter_growth, col = "blue")
lines(dates, CASSIA_preles_1998_2022$Growth$diameter_growth, col = "green")
lines(dates, CASSIA_preles_1998_2022_sugar_medium$Growth$diameter_growth, col = "gold")

# Cumulative

plot(dates, CASSIA_preles_1998_2022_sugar_low$Culm_Growth$culm_growth_height, type = "l", col = "red", ylab = "Height", xlab = "Years")
lines(dates, CASSIA_preles_1998_2022_sugar_medium$Culm_Growth$culm_growth_height, col = "gold")
lines(dates, CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height, col = "green")
lines(dates, CASSIA_preles_1998_2022_sugar_high$Culm_Growth$culm_growth_height, col = "blue")
points(as.Date(paste0(height_df$date, "-12-31")), height_df$amount, col = "green", pch = as.numeric(as.factor(height_df$variable))+16)
points(as.Date(paste0(height_cl_df$date, "-12-31")), height_cl_df$amount, col = "gold", pch = as.numeric(as.factor(height_cl_df$variable))+16)
legend("topleft", legend = unique(c(as.factor(height_df$variable), as.factor(height_cl_df$variable))), 
       pch = unique(c(as.numeric(as.factor(height_df$variable))+16, as.numeric(as.factor(height_cl_df$variable))+16)), 
       bty = "n", col = rep(c("green", "gold"),each = 4, cex = 0.75), cex = 0.5)
legend("bottomright", c("High", "Medium", "Low", "My Model"), col = c("blue", "gold", "red", "green"), lty = 1, bty = "n", cex = 0.75)

plot(dates, 0.1 * CASSIA_preles_1998_2022_sugar_low$Culm_Growth$culm_growth_diameter, type = "l", col = "red", ylab = "Diameter", xlab = "Years", ylim = c(14, 22))
lines(dates, 0.1 * CASSIA_preles_1998_2022_sugar_medium$Culm_Growth$culm_growth_diameter, col = "gold")
lines(dates, 0.1 * CASSIA_preles_1998_2022$Culm_Growth$culm_growth_diameter, col = "green")
max_diameter = 0.1 * max(CASSIA_preles_1998_2022$Culm_Growth$culm_growth_diameter, na.rm = T)
abline(h = max_diameter, col= "green", lty = 2)
lines(dates, 0.1 * CASSIA_preles_1998_2022_sugar_high$Culm_Growth$culm_growth_diameter, col = "blue")
points(as.Date(paste0(diameter_df$date, "-12-31")), diameter_df$amount, col = "green", pch = as.numeric(as.factor(diameter_df$variable))+16)
legend("bottomright", legend = unique(as.factor(diameter_df$variable)), pch = unique(as.numeric(as.factor(diameter_df$variable))+16), bty = "n", ncol = 1, col = "green", cex = 0.5)

```

```{r}
parameters_2015$sperling_test[c("sugar00"), c("Hyde")] <- 0.42

###
# Nitrogen effect
###
CASSIA_preles_1998_2022_nitrogen_high <- CASSIA_cpp(
    weather = weather_1998_2022,
    site = "Hyde",
    pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
    parameters = parameters_2015$parameters_test,
    common = common_p,
    ratios = ratios_p,
    sperling = parameters_2015$sperling_test,
    needle_mass_in = parameters_2015$needle_mass_in,
    Throughfall = parameters_2015$Throughfall,
    photosynthesis_as_input = FALSE,
    nitrogen_balance = 25,
    preles = TRUE,
    fAPAR_Tian = TRUE,
    sperling_model = TRUE
  )

CASSIA_preles_1998_2022_nitrogen_medium <- CASSIA_cpp(
    weather = weather_1998_2022,
    site = "Hyde",
    pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
    parameters = parameters_2015$parameters_test,
    common = common_p,
    ratios = ratios_p,
    sperling = parameters_2015$sperling_test,
    needle_mass_in = parameters_2015$needle_mass_in,
    Throughfall = parameters_2015$Throughfall,
    photosynthesis_as_input = FALSE,
    nitrogen_balance = 25*0.5,
    preles = TRUE,
    fAPAR_Tian = TRUE,
    sperling_model = TRUE
  )

CASSIA_preles_1998_2022_nitrogen_low  <- CASSIA_cpp(
    weather = weather_1998_2022,
    site = "Hyde",
    pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
    parameters = parameters_2015$parameters_test,
    common = common_p,
    ratios = ratios_p,
    sperling = parameters_2015$sperling_test,
    needle_mass_in = parameters_2015$needle_mass_in,
    Throughfall = parameters_2015$Throughfall,
    photosynthesis_as_input = FALSE,
    nitrogen_capacity = 25*0.3,
    preles = TRUE,
    fAPAR_Tian = TRUE,
    sperling_model = TRUE
  )

```

¤ Running scenarios: Suplus C

```{r}
parameters_2015$sperling_test[c("sugar00"), c("Hyde")] <- 0.42

objective_function <- function(par) {
  names(par) <- c(
    "Ad0.needles", "lamda.needles", "delta.needles",
    "Ad0.phloem",  "lamda.phloem",  "delta.phloem",
    "Ad0.roots",   "lamda.roots",   "delta.roots",
    "Ad0.xylem.sh","lamda.xylem.sh","delta.xylem.sh",
    "Ad0.xylem.st","lamda.xylem.st","delta.xylem.st",
    "myco.thresh",
    "percentage_needle_storage", "percentage_phloem_storage", 
    "percentage_xylem_sh_storage", "percentage_xylem_st_storage", 
    "percentage_roots_storage"
  )

  # Update parameters
  sperling_test_local <- parameters_2015$sperling_test
  sperling_test_local[names(par), "Hyde"] <- par

  tryCatch({
    model_output <- CASSIA_cpp(
      weather = weather_2015,
      site = "Hyde",
      pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
      parameters = parameters_2015$parameters_test,
      common = common_p,
      ratios = ratios_p,
      sperling = sperling_test_local,  # Only small object passed
      needle_mass_in = parameters_2015$needle_mass_in,
      Throughfall = parameters_2015$Throughfall,
      photosynthesis_as_input = FALSE,
      preles = TRUE,
      fAPAR_Tian = TRUE,
      sperling_model = TRUE,
      surplus_c = TRUE
    )
    
    # Check if model output has any non-finite values (NA, Inf, NaN)
    model_values <- c(
      model_output$Sugar$sugar_needles[autumn_indices],
      model_output$Sugar$starch_needles[autumn_indices],
      model_output$Sugar$sugar_phloem[autumn_indices],
      model_output$Sugar$starch_phloem[autumn_indices],
      model_output$Sugar$sugar_roots[autumn_indices],
      model_output$Sugar$starch_roots[autumn_indices],
      model_output$Sugar$sugar_xylem.sh[autumn_indices],
      model_output$Sugar$starch_xylem.sh[autumn_indices],
      model_output$Sugar$sugar_xylem.st[autumn_indices],
      model_output$Sugar$starch_xylem.st[autumn_indices]
    )

    # If any values are NA, Inf, or NaN, return a large penalty
    if (any(is.na(model_values) | is.infinite(model_values) | (sum(!model_output$Culm_Growth$tree_alive) > 0))) {
      return(1e10)  # Return a large penalty for invalid runs
    }

    # Calculate error
    error <- sqrt(mean((model_values - validate_sugar)^2, na.rm = TRUE))
    
    return(error)
  }, error = function(e) {
    # Catch errors during model execution and return a large penalty
    message("Error in model execution: ", e)
    return(1e10)  # Return a large penalty if an error occurs
  })
}

# Initial parameter guess
initial_guess <- c(
  # Ezymes
  0.438024, 0.002, 0.05,   # needles
  0.608733, 0.001, 0.01,   # phloem
  0.790206, 0.002, 0.05,   # roots
  0.7712,   0.002, 0.05,   # xylem.sh
  0.768777, 0.002, 0.05,   # xylem.st
  0.3,                      # myco.thresh in roots
  # Storage Capacity of each organ
  0.11, 0.11, 0.2, 0.2, 0.11
)

# Set up parallel cluster
ncores <- detectCores() - 1  # Leave 1 core free
cl <- makeCluster(ncores)

# Load libraries on workers
clusterEvalQ(cl, {
  library(CASSIA)  # Replace with your package name if needed
})

# Export necessary objects
clusterExport(cl, varlist = c(
  "CASSIA_cpp", "parameters_2015", "weather_2015",
  "validate_sugar", "common_p", "ratios_p",
  "objective_function", "autumn_indices"
))

# Aseta parametrien ala- ja ylärajat
lower_bounds <- rep(0, length(initial_guess))  # Esim. kaikki parametrit ≥ 0
upper_bounds <- rep(1, length(initial_guess)) # Max-arvot, säädä tarpeen mukaan

# Optimointi DEoptimilla
fit <- DEoptim(
  fn = objective_function,     # Sun virhefunktio
  lower = lower_bounds,        # Alarajat
  upper = upper_bounds,        # Ylärajat
  control = DEoptim.control(
    itermax = 200,             # Iteraatioiden määrä, lisää jos haluat tarkkuutta
    parallelType = 1,          # Hyödyntää clusteria jos käytössä
    cluster = cl,
    trace = TRUE               # Tulostaa edistymistä
  )
)

# Tulosteet
print(fit$optim$bestval)  # Paras löydetty virhe
print(fit$optim$bestmem)  # Parhaat parametrit

###
# Mycorrhizal allocation
###

names(fit$optim$bestmem) <- c("Ad0.needles", "lamda.needles", "delta.needles",
    "Ad0.phloem",  "lamda.phloem",  "delta.phloem",
    "Ad0.roots",   "lamda.roots",   "delta.roots",
    "Ad0.xylem.sh","lamda.xylem.sh","delta.xylem.sh",
    "Ad0.xylem.st","lamda.xylem.st","delta.xylem.st",
    "myco.thresh",
    "percentage_needle_storage", "percentage_phloem_storage", 
    "percentage_xylem_sh_storage", "percentage_xylem_st_storage", 
    "percentage_roots_storage")

# Update parameters
parameters_2015$sperling_test[names(fit$optim$bestmem), "Hyde"] <- fit$optim$bestmem

CASSIA_preles_1998_2022_roots_surplus_c <- CASSIA_cpp(
    weather = weather_1998_2022,
    site = "Hyde",
    pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
    parameters = parameters_2015$parameters_test,
    common = common_p,
    ratios = ratios_p,
    sperling = parameters_2015$sperling_test,
    needle_mass_in = parameters_2015$needle_mass_in,
    Throughfall = parameters_2015$Throughfall,
    photosynthesis_as_input = FALSE,
    preles = TRUE,
    fAPAR_Tian = TRUE,
    sperling_model = TRUE,
    surplus_c = TRUE
  )
```

```{r}
###
# Yearly view
###

ylim = range(0, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_needles, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_phloem, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_xylem_sh, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_xylem_st, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_roots, na.rm = T)
if (is.infinite(ylim[2])) {
  ylim[2] = 1
}
par(mfrow = c(1, 2))
plot(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_needles[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "green", ylim = ylim, main = "Sugar (all organs)", ylab = "Sugar", xlab = "Date")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$needles_sugar, col = "green")
lines(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_xylem_st[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "gold")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_st_sugar, col = "gold")
lines(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_phloem[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "brown")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$phloem_sugar, col = "brown")
lines(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_xylem_sh[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "red")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_sh_sugar, col = "red")
lines(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_roots[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "black")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$roots_sugar, col = "black")


# CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_xylem_sh
ylim = range(0, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_needles, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_phloem, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_xylem_st, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_roots, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_xylem_sh, na.rm = T)
plot(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_needles[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "green", ylim = ylim, main = "Starch (all organs)", ylab = "Starch", xlab = "Date")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$needles_starch, col = "green")
lines(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_phloem[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "brown")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$phloem_starch, col = "brown")
lines(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_xylem_sh[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "red")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_sh_starch, col = "red")
lines(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_xylem_st[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "gold")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_st_starch, col = "gold")
lines(dates[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch_roots[CASSIA_preles_1998_2022_roots_surplus_c$Growth$year == 2015], type = "l", col = "black")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$roots_starch, col = "black")
```


# Nitrogen feedback: Recalibrate

```{r}
parameters_2015$sperling_test[c("sugar00"), c("Hyde")] <- 0.42

objective_function <- function(par) {
  names(par) <- c(
    "Ad0.needles", "lamda.needles", "delta.needles",
    "Ad0.phloem",  "lamda.phloem",  "delta.phloem",
    "Ad0.roots",   "lamda.roots",   "delta.roots",
    "Ad0.xylem.sh","lamda.xylem.sh","delta.xylem.sh",
    "Ad0.xylem.st","lamda.xylem.st","delta.xylem.st",
    "myco.thresh",
    "percentage_needle_storage", "percentage_phloem_storage", 
    "percentage_xylem_sh_storage", "percentage_xylem_st_storage", 
    "percentage_roots_storage"
  )

  # Update parameters
  sperling_test_local <- parameters_2015$sperling_test
  sperling_test_local[names(par), "Hyde"] <- par

  tryCatch({
    model_output <- CASSIA_cpp(
      weather = weather_2015,
      site = "Hyde",
      pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
      parameters = parameters_2015$parameters_test,
      common = common_p,
      ratios = ratios_p,
      sperling = sperling_test_local,  # Only small object passed
      needle_mass_in = parameters_2015$needle_mass_in,
      Throughfall = parameters_2015$Throughfall,
      photosynthesis_as_input = FALSE,
      preles = TRUE,
      fAPAR_Tian = TRUE,
      sperling_model = TRUE,
      surplus_c = TRUE
    )
    
    # Check if model output has any non-finite values (NA, Inf, NaN)
    model_values <- c(
      model_output$Sugar$sugar_needles[autumn_indices],
      model_output$Sugar$starch_needles[autumn_indices],
      model_output$Sugar$sugar_phloem[autumn_indices],
      model_output$Sugar$starch_phloem[autumn_indices],
      model_output$Sugar$sugar_roots[autumn_indices],
      model_output$Sugar$starch_roots[autumn_indices],
      model_output$Sugar$sugar_xylem.sh[autumn_indices],
      model_output$Sugar$starch_xylem.sh[autumn_indices],
      model_output$Sugar$sugar_xylem.st[autumn_indices],
      model_output$Sugar$starch_xylem.st[autumn_indices]
    )

    # If any values are NA, Inf, or NaN, return a large penalty
    if (any(is.na(model_values) | is.infinite(model_values) | (sum(!model_output$Culm_Growth$tree_alive) > 0))) {
      return(1e10)  # Return a large penalty for invalid runs
    }

    # Calculate error
    error <- sqrt(mean((model_values - validate_sugar)^2, na.rm = TRUE))
    
    return(error)
  }, error = function(e) {
    # Catch errors during model execution and return a large penalty
    message("Error in model execution: ", e)
    return(1e10)  # Return a large penalty if an error occurs
  })
}

# Initial parameter guess
initial_guess <- c(
  # Ezymes
  0.438024, 0.002, 0.05,   # needles
  0.608733, 0.001, 0.01,   # phloem
  0.790206, 0.002, 0.05,   # roots
  0.7712,   0.002, 0.05,   # xylem.sh
  0.768777, 0.002, 0.05,   # xylem.st
  0.3,                      # myco.thresh in roots
  # Storage Capacity of each organ
  0.11, 0.11, 0.2, 0.2, 0.11
)

# Set up parallel cluster
ncores <- detectCores() - 1  # Leave 1 core free
cl <- makeCluster(ncores)

# Load libraries on workers
clusterEvalQ(cl, {
  library(CASSIA)  # Replace with your package name if needed
})

# Export necessary objects
clusterExport(cl, varlist = c(
  "CASSIA_cpp", "parameters_2015", "weather_2015",
  "validate_sugar", "common_p", "ratios_p",
  "objective_function", "autumn_indices"
))

# Aseta parametrien ala- ja ylärajat
lower_bounds <- rep(0, length(initial_guess))  # Esim. kaikki parametrit ≥ 0
upper_bounds <- rep(1, length(initial_guess)) # Max-arvot, säädä tarpeen mukaan

# Optimointi DEoptimilla
fit <- DEoptim(
  fn = objective_function,     # Sun virhefunktio
  lower = lower_bounds,        # Alarajat
  upper = upper_bounds,        # Ylärajat
  control = DEoptim.control(
    itermax = 200,             # Iteraatioiden määrä, lisää jos haluat tarkkuutta
    parallelType = 1,          # Hyödyntää clusteria jos käytössä
    cluster = cl,
    trace = TRUE               # Tulostaa edistymistä
  )
)

# Tulosteet
print(fit$optim$bestval)  # Paras löydetty virhe
print(fit$optim$bestmem)  # Parhaat parametrit

###
# Nitrogen feedback
###

names(fit$optim$bestmem) <- c("Ad0.needles", "lamda.needles", "delta.needles",
    "Ad0.phloem",  "lamda.phloem",  "delta.phloem",
    "Ad0.roots",   "lamda.roots",   "delta.roots",
    "Ad0.xylem.sh","lamda.xylem.sh","delta.xylem.sh",
    "Ad0.xylem.st","lamda.xylem.st","delta.xylem.st",
    "myco.thresh",
    "percentage_needle_storage", "percentage_phloem_storage", 
    "percentage_xylem_sh_storage", "percentage_xylem_st_storage", 
    "percentage_roots_storage")

# Update parameters
parameters_2015$sperling_test[names(fit$optim$bestmem), "Hyde"] <- fit$optim$bestmem

CASSIA_preles_1998_2022_nitrogen_varies <- CASSIA_cpp(
    weather = weather_1998_2022,
    site = "Hyde",
    pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
    parameters = parameters_2015$parameters_test,
    common = common_p,
    ratios = ratios_p,
    sperling = parameters_2015$sperling_test,
    needle_mass_in = parameters_2015$needle_mass_in,
    Throughfall = parameters_2015$Throughfall,
    photosynthesis_as_input = FALSE,
    nitrogen_balance = 25*0.3,
    nitrogen_change = TRUE,
    preles = TRUE,
    fAPAR_Tian = TRUE,
    sperling_model = TRUE
  )
```


```{r}
parameters_2015$sperling_test[c("sugar00"), c("Hyde")] <- 0.42

objective_function <- function(par) {
  names(par) <- c(
    "Ad0.needles", "lamda.needles", "delta.needles",
    "Ad0.phloem",  "lamda.phloem",  "delta.phloem",
    "Ad0.roots",   "lamda.roots",   "delta.roots",
    "Ad0.xylem.sh","lamda.xylem.sh","delta.xylem.sh",
    "Ad0.xylem.st","lamda.xylem.st","delta.xylem.st",
    "myco.thresh",
    "percentage_needle_storage", "percentage_phloem_storage", 
    "percentage_xylem_sh_storage", "percentage_xylem_st_storage", 
    "percentage_roots_storage"
  )

  # Update parameters
  sperling_test_local <- parameters_2015$sperling_test
  sperling_test_local[names(par), "Hyde"] <- par

  tryCatch({
    model_output <- CASSIA_cpp(
      weather = weather_2015,
      site = "Hyde",
      pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
      parameters = parameters_2015$parameters_test,
      common = common_p,
      ratios = ratios_p,
      sperling = sperling_test_local,  # Only small object passed
      needle_mass_in = parameters_2015$needle_mass_in,
      Throughfall = parameters_2015$Throughfall,
      photosynthesis_as_input = FALSE,
      preles = TRUE,
      fAPAR_Tian = TRUE,
      sperling_model = TRUE,
      surplus_c = TRUE
    )
    
    # Check if model output has any non-finite values (NA, Inf, NaN)
    model_values <- c(
      model_output$Sugar$sugar_needles[autumn_indices],
      model_output$Sugar$starch_needles[autumn_indices],
      model_output$Sugar$sugar_phloem[autumn_indices],
      model_output$Sugar$starch_phloem[autumn_indices],
      model_output$Sugar$sugar_roots[autumn_indices],
      model_output$Sugar$starch_roots[autumn_indices],
      model_output$Sugar$sugar_xylem.sh[autumn_indices],
      model_output$Sugar$starch_xylem.sh[autumn_indices],
      model_output$Sugar$sugar_xylem.st[autumn_indices],
      model_output$Sugar$starch_xylem.st[autumn_indices]
    )

    # If any values are NA, Inf, or NaN, return a large penalty
    if (any(is.na(model_values) | is.infinite(model_values) | (sum(!model_output$Culm_Growth$tree_alive) > 0))) {
      return(1e10)  # Return a large penalty for invalid runs
    }

    # Calculate error
    error <- sqrt(mean((model_values - validate_sugar)^2, na.rm = TRUE))
    
    return(error)
  }, error = function(e) {
    # Catch errors during model execution and return a large penalty
    message("Error in model execution: ", e)
    return(1e10)  # Return a large penalty if an error occurs
  })
}

# Initial parameter guess
initial_guess <- c(
  # Ezymes
  0.438024, 0.002, 0.05,   # needles
  0.608733, 0.001, 0.01,   # phloem
  0.790206, 0.002, 0.05,   # roots
  0.7712,   0.002, 0.05,   # xylem.sh
  0.768777, 0.002, 0.05,   # xylem.st
  0.3,                      # myco.thresh in roots
  # Storage Capacity of each organ
  0.11, 0.11, 0.2, 0.2, 0.11
)

# Set up parallel cluster
ncores <- detectCores() - 1  # Leave 1 core free
cl <- makeCluster(ncores)

# Load libraries on workers
clusterEvalQ(cl, {
  library(CASSIA)  # Replace with your package name if needed
})

# Export necessary objects
clusterExport(cl, varlist = c(
  "CASSIA_cpp", "parameters_2015", "weather_2015",
  "validate_sugar", "common_p", "ratios_p",
  "objective_function", "autumn_indices"
))

# Aseta parametrien ala- ja ylärajat
lower_bounds <- rep(0, length(initial_guess))  # Esim. kaikki parametrit ≥ 0
upper_bounds <- rep(1, length(initial_guess)) # Max-arvot, säädä tarpeen mukaan

# Optimointi DEoptimilla
fit <- DEoptim(
  fn = objective_function,     # Sun virhefunktio
  lower = lower_bounds,        # Alarajat
  upper = upper_bounds,        # Ylärajat
  control = DEoptim.control(
    itermax = 200,             # Iteraatioiden määrä, lisää jos haluat tarkkuutta
    parallelType = 1,          # Hyödyntää clusteria jos käytössä
    cluster = cl,
    trace = TRUE               # Tulostaa edistymistä
  )
)

# Tulosteet
print(fit$optim$bestval)  # Paras löydetty virhe
print(fit$optim$bestmem)  # Parhaat parametrit

###
# Nitrogen Investment
###

names(fit$optim$bestmem) <- c("Ad0.needles", "lamda.needles", "delta.needles",
    "Ad0.phloem",  "lamda.phloem",  "delta.phloem",
    "Ad0.roots",   "lamda.roots",   "delta.roots",
    "Ad0.xylem.sh","lamda.xylem.sh","delta.xylem.sh",
    "Ad0.xylem.st","lamda.xylem.st","delta.xylem.st",
    "myco.thresh",
    "percentage_needle_storage", "percentage_phloem_storage", 
    "percentage_xylem_sh_storage", "percentage_xylem_st_storage", 
    "percentage_roots_storage")

# Update parameters
parameters_2015$sperling_test[names(fit$optim$bestmem), "Hyde"] <- fit$optim$bestmem

CASSIA_preles_1998_2022_nitrogen_investment <- CASSIA_cpp(
    weather = weather_1998_2022,
    site = "Hyde",
    pPREL = c(parameters_2015$pPREL, parameters_2015$N_parameters),
    parameters = parameters_2015$parameters_test,
    common = common_p,
    ratios = ratios_p,
    sperling = parameters_2015$sperling_test,
    needle_mass_in = parameters_2015$needle_mass_in,
    Throughfall = parameters_2015$Throughfall,
    photosynthesis_as_input = FALSE,
    nitrogen_balance = 25*0.3,
    nitrogen_change = FALSE,
    nitrogen_contrast = FALSE,
    preles = TRUE,
    fAPAR_Tian = FALSE,
    sperling_model = TRUE)

```

```{r}
###
# Yearly view
###

ylim = range(0, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_needles, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_phloem, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_xylem_sh, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_xylem_st, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_roots, na.rm = T)
if (is.infinite(ylim[2])) {
  ylim[2] = 1
}
par(mfrow = c(1, 2))
plot(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_needles[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "green", ylim = ylim, main = "Sugar (all organs)", ylab = "Sugar", xlab = "Date")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$needles_sugar, col = "green")
lines(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_xylem_st[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "gold")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_st_sugar, col = "gold")
lines(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_phloem[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "brown")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$phloem_sugar, col = "brown")
lines(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_xylem_sh[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "red")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_sh_sugar, col = "red")
lines(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_roots[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "black")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$roots_sugar, col = "black")


# CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_xylem_sh
ylim = range(0, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_needles, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_phloem, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_xylem_st, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_roots, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_xylem_sh, na.rm = T)
plot(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_needles[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "green", ylim = ylim, main = "Starch (all organs)", ylab = "Starch", xlab = "Date")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$needles_starch, col = "green")
lines(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_phloem[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "brown")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$phloem_starch, col = "brown")
lines(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_xylem_sh[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "red")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_sh_starch, col = "red")
lines(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_xylem_st[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "gold")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$xylem_st_starch, col = "gold")
lines(dates[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch_roots[CASSIA_preles_1998_2022_nitrogen_investment$Growth$year == 2015], type = "l", col = "black")
points(as.Date(rownames(loaded_data$original_data)), loaded_data$original_data$roots_starch, col = "black")
```


# Plots of scenarios

```{r}
# Cleaning the data
height_df <- height_df[height_df$variable == "tree_height_baseal_area_weighted_mean",]

###
# Carbon scenarios
###

#png("surplus_c.png", width = 2000, height = 1600, res = 300)
par(mfrow = c(1, 2))
ylim = range(0, c(CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height,
                  CASSIA_preles_1998_2022_roots_surplus_c$Culm_Growth$culm_growth_height,
                  height_df$amount,
                  height_cl_df$amount), 
             na.rm = T)
ylim[1] = 12
plot(dates, CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height, col = "green", type = "l", main = "Height", ylim = ylim, ylab = "Height, m", xlab = "Years")
lines(dates, CASSIA_preles_1998_2022_roots_surplus_c$Culm_Growth$culm_growth_height, col = "red")
legend("bottomright", c("Control", "Conservative Carbohydrates"), col = c("green", "red"), , cex = 0.75, bty = "n", lty = 1)
points(as.Date(paste0(height_df$date, "-12-31")), height_df$amount, col = "green", pch = as.numeric(as.factor(height_df$variable))+16)
points(as.Date(paste0(height_cl_df$date, "-12-31")), height_cl_df$amount, col = "gold", pch = as.numeric(as.factor(height_cl_df$variable))+16)
legend("topleft", legend = c("Tree Height\nBasal Area Weighted Mean"), 
       pch = unique(c(as.numeric(as.factor(height_df$variable))+16, as.numeric(as.factor(height_cl_df$variable))+16)), 
       bty = "n", col = rep(c("green", "gold"),each = 4, cex = 0.75), cex = 0.75)

ylim = range(c(0, 
               max(cumsum(CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_mycorrhiza)), 
               max(cumsum(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza)),
               cumsum(CASSIA_preles_1998_2022_nitrogen_varies$Sugar$sugar_mycorrhiza)), na.rm = TRUE)
# Mycorrhizal allocation
plot(dates, cumsum(CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_mycorrhiza), col = "red", main = "Cumulative Allocation\n to Mycorrhiza", xlab = "Years", ylab = "Sugar to Mycorrhiza, kg", ylim = ylim, type = "l")
lines(dates, cumsum(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza), type = "l", col = "green")
legend("bottomright", c("Control", "Conservative Carbohydrates"), col = c("green", "red"), , cex = 0.75, bty = "n", lty = 1)
#dev.off()

#png("starch.png", width = 2000, height = 1600, res = 300)
ylim = range(c(CASSIA_preles_1998_2022$Sugar$sugar, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar), na.rm = T)
if (ylim[2] > 1) {
  ylim[2] = 1.2
}
plot(dates, CASSIA_preles_1998_2022$Sugar$sugar, col = "green", type = "l", main = "Sugar in the Tree", ylab = "Sugar in Tree, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar, col = "red")
abline(h = mean(CASSIA_preles_1998_2022$Sugar$sugar, na.rm = T), lty = 2, col = "green")
abline(h = mean(CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar, na.rm = T), lty = 2, col = "red")

ylim = range(c(CASSIA_preles_1998_2022$Sugar$starch, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$starch, col = "green", type = "l", main = "Starch in the Tree", ylab = "Starch in Tree, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch, col = "red")
abline(h = mean(CASSIA_preles_1998_2022$Sugar$starch), lty = 2, col = "green")
abline(h = mean(CASSIA_preles_1998_2022_roots_surplus_c$Sugar$starch), lty = 2, col = "red")
#dev.off()

ylim = range(c(CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza), na.rm = T)
if (ylim[2] > 1) {
  ylim[2] = 1.2
}
plot(dates, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_mycorrhiza, col = "red", type = "l", main = "Allocation to Mycorrhiza", ylab = "Sugar to Mycorrhiza, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza, col = "green")


plot(dates, 100*CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022_roots_surplus_c$Sugar$sugar, col = "red", type = "l", main = "Sugar % to mycorrhiza", ylab = "Sugar % to Mycorrhiza", xlab = "Years", ylim = c(0, 100))
lines(dates, 100*CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022$Sugar$sugar, col = "green")

par(mfrow = c(1, 2))
plot(dates, CASSIA_preles_1998_2022_roots_surplus_c$Culm_Growth$nitrogen_capacity_needles, type = "l", xlab = "Years", ylab = "Nitorgen Capacity (between 0 and 1)", col = "red", ylim = c(0, 1))
lines(dates, CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_needles, col = "green")

plot(dates, CASSIA_preles_1998_2022_roots_surplus_c$Sugar$storage/5, type = "l", xlab = "Years", ylab = "Tree Storage (between 0 and 1)", col = "red", ylim = c(0, 1))
lines(dates, CASSIA_preles_1998_2022$Sugar$storage/5, col = "green")

###
# Nitrogen effect
###
#png("nitrogen_effect_constant.png", width = 2000, height = 1600, res = 300)
par(mfrow = c(1, 2))
ylim = range(0, c(CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height,
                  CASSIA_preles_1998_2022_nitrogen_high$Culm_Growth$culm_growth_height,
                  CASSIA_preles_1998_2022_nitrogen_medium$Culm_Growth$culm_growth_height,
                  CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$culm_growth_height,
                  height_df$amount,
                  height_cl_df$amount), 
             na.rm = T)
ylim[1] = 12
plot(dates, CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height, col = "green", type = "l", main = "Height", ylim = ylim, ylab = "Height, m", xlab = "Years")
lines(dates, CASSIA_preles_1998_2022_nitrogen_high$Culm_Growth$culm_growth_height, col = "blue")
lines(dates, CASSIA_preles_1998_2022_nitrogen_medium$Culm_Growth$culm_growth_height, col = "orange")
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$culm_growth_height, col = "red")
legend("bottomright", c("Control", "High Nitrogen", "Medium Nitrogen", "Low Nitrogen"), col = c("green", "blue", "orange", "red"), cex = 0.75, bty = "n", lty = 1)
points(as.Date(paste0(height_df$date, "-12-31")), height_df$amount, col = "green", pch = as.numeric(as.factor(height_df$variable))+16)
points(as.Date(paste0(height_cl_df$date, "-12-31")), height_cl_df$amount, col = "gold", pch = as.numeric(as.factor(height_cl_df$variable))+16)
legend("topleft", legend = c("Tree Height\nBasal Area Weighted Mean"), 
       pch = unique(c(as.numeric(as.factor(height_df$variable))+16, as.numeric(as.factor(height_cl_df$variable))+16)), 
       bty = "n", col = rep(c("green", "gold"),each = 4, cex = 0.75), cex = 0.75)

ylim = range(c(0, 
               cumsum(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza),
               cumsum(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza), 
               cumsum(CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar_mycorrhiza), 
               cumsum(CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza)), na.rm = T)
plot(dates, cumsum(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza), col = "green", type = "l", main = "Cumulative Allocation\n to Mycorrhiza", ylab = "Sugar to Mycorrhiza, kg", xlab = "Years", ylim = ylim)
lines(dates, cumsum(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza), col = "red")
lines(dates, cumsum(CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza), col = "orange")
lines(dates, cumsum(CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar_mycorrhiza), col = "blue")
legend("bottomright", c("Control", "High Nitrogen", "Medium Nitrogen", "Low Nitrogen"), col = c("green", "blue", "orange", "red"), cex = 0.75, bty = "n", lty = 1)
#dev.off()

ylim = range(c(CASSIA_preles_1998_2022$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$sugar, col = "green", type = "l", main = "Sugar in the Tree", ylab = "Sugar in Tree, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar, col = "orange")
lines(dates, CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar, col = "blue")
abline(h = mean(CASSIA_preles_1998_2022$Sugar$sugar), lty = 2, col = "green")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar), lty = 2, col = "red")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar), lty = 2, col = "orange")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar), lty = 2, col = "blue")

ylim = range(c(CASSIA_preles_1998_2022$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_high$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_low$Sugar$starch), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$starch, col = "green", type = "l", main = "Starch in the Tree", ylab = "Starch in Tree, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$starch, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$starch, col = "orange")
lines(dates, CASSIA_preles_1998_2022_nitrogen_high$Sugar$starch, col = "blue")
abline(h = mean(CASSIA_preles_1998_2022$Sugar$starch), lty = 2, col = "green")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_medium$Sugar$starch), lty = 2, col = "orange")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_low$Sugar$starch), lty = 2, col = "red")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_high$Sugar$starch), lty = 2, col = "blue")

ylim = range(c(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza, col = "green", type = "l", main = "Allocation to mycorrhiza", ylab = "Sugar to Mycorrhiza, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza, col = "orange")
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar_mycorrhiza, col = "blue")

plot(dates, 100*CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022$Sugar$sugar, col = "green", type = "l", main = "Sugar % to mycorrhiza", ylab = "Sugar % to Mycorrhiza", xlab = "Years", ylim = c(0, 50))
lines(dates, 100*CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar, col = "red")
lines(dates, 100*CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar, col = "orange")
lines(dates, 100*CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar, col = "blue")

par(mfrow = c(1, 2))
plot(dates, (CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_needles +
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_roots)/5, type = "l", xlab = "Years", ylab = "Nitorgen Capacity (between 0 and 1)", col = "red", ylim = c(0, 1))
lines(dates, (CASSIA_preles_1998_2022_nitrogen_medium$Culm_Growth$nitrogen_capacity_needles +
                CASSIA_preles_1998_2022_nitrogen_medium$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022_nitrogen_medium$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022_nitrogen_medium$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022_nitrogen_medium$Culm_Growth$nitrogen_capacity_roots)/5, col = "orange")
lines(dates, (CASSIA_preles_1998_2022_nitrogen_high$Culm_Growth$nitrogen_capacity_needles +
                CASSIA_preles_1998_2022_nitrogen_high$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022_nitrogen_high$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022_nitrogen_high$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022_nitrogen_high$Culm_Growth$nitrogen_capacity_roots)/5, col = "blue")
lines(dates, (CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_needles +
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_roots)/5, col = "green")

plot(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$storage/5, type = "l", xlab = "Years", ylab = "Tree Storage (between 0 and 1)", col = "red", ylim = c(0, 1))
lines(dates, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$storage/5, col = "orange")
lines(dates, CASSIA_preles_1998_2022_nitrogen_high$Sugar$storage/5, col = "blue")
lines(dates, CASSIA_preles_1998_2022$Sugar$storage/5, col = "green")

###
# Nitrogen Response
###
#png("nitrogen_varies.png", width = 2000, height = 1600, res = 300)
par(mfrow = c(1, 2))
ylim = range(0, c(CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height,
                  CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$culm_growth_height,
                  CASSIA_preles_1998_2022_nitrogen_varies$Culm_Growth$culm_growth_height,
                  height_df$amount,
                  height_cl_df$amount), 
             na.rm = T)
ylim[1] = 12
plot(dates, CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height, col = "green", type = "l", main = "Height", ylim = ylim, ylab = "Height, m", xlab = "Years")
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$culm_growth_height, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_varies$Culm_Growth$culm_growth_height, col = "purple")
legend("bottomright", c("Control", "Low Nitrogen", "Varied Nitrogen"), col = c("green", "red", "purple"), cex = 0.75, bty = "n", lty = 1)
points(as.Date(paste0(height_df$date, "-12-31")), height_df$amount, col = "green", pch = as.numeric(as.factor(height_df$variable))+16)
points(as.Date(paste0(height_cl_df$date, "-12-31")), height_cl_df$amount, col = "gold", pch = as.numeric(as.factor(height_cl_df$variable))+16)
legend("topleft", legend = c("Tree Height\nBasal Area Weighted Mean"), 
       pch = unique(c(as.numeric(as.factor(height_df$variable))+16, as.numeric(as.factor(height_cl_df$variable))+16)), 
       bty = "n", col = rep(c("green", "gold"),each = 4, cex = 0.75), cex = 0.75)

ylim = range(c(0, 
               cumsum(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza), 
               cumsum(CASSIA_preles_1998_2022_nitrogen_varies$Sugar$sugar_mycorrhiza),
               cumsum(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza)), na.rm = T)
plot(dates, cumsum(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza), col = "green", type = "l", main = "Cumulative Allocation\n to Mycorrhiza", ylab = "Sugar to Mycorrhiza, kg", xlab = "Years", ylim = ylim)
lines(dates, cumsum(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza), col = "red")
lines(dates, cumsum(CASSIA_preles_1998_2022_nitrogen_varies$Sugar$sugar_mycorrhiza), col = "purple")
legend("bottomright", c("Control", "Low Nitrogen", "Varied Nitrogen"), col = c("green", "red", "purple"), cex = 0.75, bty = "n", lty = 1)
#dev.off()

ylim = range(c(CASSIA_preles_1998_2022$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$sugar, col = "green", type = "l", main = "Sugar in the Tree", ylab = "Sugar in Tree, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_varies$Sugar$sugar, col = "purple")
abline(h = mean(CASSIA_preles_1998_2022$Sugar$sugar), lty = 2, col = "green")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar), lty = 2, col = "red")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_varies$Sugar$sugar), lty = 2, col = "purple")

ylim = range(c(CASSIA_preles_1998_2022$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_high$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_low$Sugar$starc, CASSIA_preles_1998_2022_nitrogen_varies$Sugar$starch), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$starch, col = "green", type = "l", main = "Starch in the Tree", ylab = "Starch in Tree, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$starch, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_varies$Sugar$starch, col = "purple")
abline(h = mean(CASSIA_preles_1998_2022$Sugar$starch), lty = 2, col = "green")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_low$Sugar$starch), lty = 2, col = "red")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_varies$Sugar$starch), lty = 2, col = "purple")

ylim = range(c(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_varies$Sugar$starch), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza, col = "green", type = "l", main = "Allocation to mycorrhiza", ylab = "Sugar to Mycorrhiza, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_varies$Sugar$sugar_mycorrhiza, col = "purple")

plot(dates, 100*CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022$Sugar$sugar, col = "green", type = "l", main = "Sugar % to mycorrhiza", ylab = "Sugar % to Mycorrhiza", xlab = "Years", ylim = c(0, 50))
lines(dates, 100*CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar, col = "red")
lines(dates, 100*CASSIA_preles_1998_2022_nitrogen_varies$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022_nitrogen_varies$Sugar$sugar, col = "purple")

#png("nitrogen_store.png", width = 2000, height = 1600, res = 300)
par(mfrow = c(1, 2))
# TODO: referencing - what is the correct reference?
plot(dates, (CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_needles +
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_roots)/5, type = "l", xlab = "Years", ylab = "Nitorgen Capacity (between 0 and 1)", col = "red", ylim = c(0, 1))
lines(dates, (CASSIA_preles_1998_2022_nitrogen_varies$Culm_Growth$nitrogen_capacity_needles +
                CASSIA_preles_1998_2022_nitrogen_varies$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022_nitrogen_varies$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022_nitrogen_varies$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022_nitrogen_varies$Culm_Growth$nitrogen_capacity_roots)/5, col = "purple")
lines(dates, (CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_needles +
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_roots)/5, col = "green")

plot(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$storage/5, type = "l", xlab = "Years", ylab = "Tree Storage (between 0 and 1)", col = "red", ylim = c(0, 1))
lines(dates, CASSIA_preles_1998_2022_nitrogen_varies$Sugar$storage/5, col = "purple")
lines(dates, CASSIA_preles_1998_2022$Sugar$storage/5, col = "green")
#dev.off()

###
# Nitrogen Interaction
###

par(mfrow = c(1, 2))
ylim = range(0, c(CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height,
                  CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$culm_growth_height,
                  CASSIA_preles_1998_2022_nitrogen_investment$Culm_Growth$culm_growth_height,
                  height_df$amount,
                  height_cl_df$amount), 
             na.rm = T)
ylim[1] = 12
plot(dates, CASSIA_preles_1998_2022$Culm_Growth$culm_growth_height, col = "green", type = "l", main = "Height", ylim = ylim, ylab = "Height, m", xlab = "Years")
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$culm_growth_height, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_investment$Culm_Growth$culm_growth_height, col = "pink")
legend("bottomright", c("Control", "Low Nitrogen", "Invested Nitrogen"), col = c("green", "red", "pink"), cex = 0.75, bty = "n", lty = 1)
points(as.Date(paste0(height_df$date, "-12-31")), height_df$amount, col = "green", pch = as.numeric(as.factor(height_df$variable))+16)
points(as.Date(paste0(height_cl_df$date, "-12-31")), height_cl_df$amount, col = "gold", pch = as.numeric(as.factor(height_cl_df$variable))+16)
legend("topleft", legend = c("Tree Height\nBasal Area Weighted Mean"), 
       pch = unique(c(as.numeric(as.factor(height_df$variable))+16, as.numeric(as.factor(height_cl_df$variable))+16)), 
       bty = "n", col = rep(c("green", "gold"),each = 4, cex = 0.75), cex = 0.75)

ylim = range(c(0, 
               cumsum(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza), 
               cumsum(CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_mycorrhiza),
               cumsum(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza)), na.rm = T)
plot(dates, cumsum(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza), col = "green", type = "l", main = "Cumulative Allocation\n to Mycorrhiza", ylab = "Sugar to Mycorrhiza, kg", xlab = "Years", ylim = ylim)
lines(dates, cumsum(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza), col = "red")
lines(dates, cumsum(CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_mycorrhiza), col = "pink")
legend("bottomright", c("Control", "Low Nitrogen", "Invested Nitrogen"), col = c("green", "red", "pink"), cex = 0.75, bty = "n", lty = 1)

ylim = range(c(CASSIA_preles_1998_2022$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$sugar, col = "green", type = "l", main = "Sugar in the Tree", ylab = "Sugar in Tree, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar, col = "pink")
abline(h = mean(CASSIA_preles_1998_2022$Sugar$sugar), lty = 2, col = "green")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar), lty = 2, col = "red")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar), lty = 2, col = "pink")

ylim = range(c(CASSIA_preles_1998_2022$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_high$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_low$Sugar$starch, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$starch, col = "green", type = "l", main = "Starch in the Tree", ylab = "Starch in Tree, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$starch, col = "red")
lines(dates, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch, col = "pink")
abline(h = mean(CASSIA_preles_1998_2022$Sugar$starch), lty = 2, col = "green")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_low$Sugar$starch), lty = 2, col = "red")
abline(h = mean(CASSIA_preles_1998_2022_nitrogen_investment$Sugar$starch), lty = 2, col = "pink")

ylim = range(c(CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_high$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_mycorrhiza), na.rm = T)
plot(dates, CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza, col = "green", type = "l", main = "Allocation to mycorrhiza", ylab = "Sugar to Mycorrhiza, kg", xlab = "Years", ylim = ylim)
lines(dates, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_mycorrhiza, col = "pink")
lines(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$sugar_mycorrhiza, col = "red")

plot(dates, 100*CASSIA_preles_1998_2022$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022$Sugar$sugar, col = "green", type = "l", main = "Sugar % to mycorrhiza", ylab = "Sugar % to Mycorrhiza", xlab = "Years", ylim = c(0, 50))
lines(dates, 100*CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022_nitrogen_investment$Sugar$sugar, col = "pink")
lines(dates, 100*CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar_mycorrhiza/CASSIA_preles_1998_2022_nitrogen_medium$Sugar$sugar, col = "red")

par(mfrow = c(1, 2))
plot(dates, (CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity +
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022_nitrogen_low$Culm_Growth$nitrogen_capacity_roots)/5, type = "l", xlab = "Years", ylab = "Nitorgen Capacity (between 0 and 1)", col = "red", ylim = c(0, 1))
lines(dates, (CASSIA_preles_1998_2022_nitrogen_investment$Sugar$nitrogen_capacity +
                CASSIA_preles_1998_2022_nitrogen_investment$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022_nitrogen_investment$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022_nitrogen_investment$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022_nitrogen_investment$Culm_Growth$nitrogen_capacity_roots)/5, col = "pink")
lines(dates, (CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_needles +
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_bud +
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_height + 
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_wall + 
                CASSIA_preles_1998_2022$Culm_Growth$nitrogen_capacity_roots)/5, col = "green")

plot(dates, CASSIA_preles_1998_2022_nitrogen_low$Sugar$storage/5, type = "l", xlab = "Years", ylab = "Tree Storage (between 0 and 1)", col = "red", ylim = c(0, 1))
lines(dates, CASSIA_preles_1998_2022_nitrogen_investment$Sugar$storage/5, col = "pink")
lines(dates, CASSIA_preles_1998_2022$Sugar$storage/5, col = "green")
```


