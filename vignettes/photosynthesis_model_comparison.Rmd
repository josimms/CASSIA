---
title: "photosynthesis_model_comparison"
author: "Joanna"
date: "2025-01-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Weather comparison

```{r}
data <- data.table::as.data.table(readxl::read_xlsx("~/Documents/CASSIA_Calibration/Raw_Data/hyy_all_2008_2019.xlsx", sheet = 1, skip = 1))
names(data) <- names(readxl::read_xlsx("~/Documents/CASSIA_Calibration/Raw_Data/hyy_all_2008_2019.xlsx", sheet = 1))

plot(as.Date(weather_preles$date), weather_preles$PAR, col = "blue", ylab = "PAR", xlab = "Date")
points(as.Date(data$Date), data$PAR)

plot(as.Date(weather_preles$date), weather_preles$T, col = "blue", ylab = "Temperature", xlab = "Date")
points(as.Date(data$Date), data$TA_F)

plot(as.Date(weather_preles$date), weather_preles$Rain, col = "blue", ylab = "Rain / Precipitation", xlab = "Date")
points(as.Date(data$Date), data$P_F)

plot(as.Date(weather_preles$date), weather_preles$VPD, col = "blue", ylab = "VPD", xlab = "Date")
points(as.Date(data$Date), data$VPD_F...8)
```

## Run the models

```{r}
# Parameters
new_parameters <- rep(0.5, 27)  # Example new parameters
calibration = F
parameters_all <- initialize_parameters(calibration, new_parameters)

# Import weather data
weather_original <- read_and_combine_weather_data(2015, 2018, base_path = "~/Documents/CASSIA/data/weather_original_")
weather_original$date <- as.Date(strptime(paste(rep(2015:2018, times = c(365, 366, 365, 365)), weather_original$X), format = "%Y %j"))

weather_preles <- data.table::fread("~/Documents/CASSIA/data/ERA5_CASSIA_preles.csv")

# GPP from SMEAR

smear <- data.table::fread("~/Documents/CASSIA/data/daily_dataframe.csv")

# Models

CASSIA_spp <- CASSIA_cpp(weather_original, "Hyde", tests = TRUE)

CASSIA_preles <- CASSIA_cpp(weather = weather_preles,
                            site = "Hyde",
                            pPREL = c(parameters_all$pPREL, parameters_all$N_parameters),
                            parameters = parameters_all$parameters_test,
                            common = common_p,
                            ratios = ratios_p,
                            sperling = parameters_all$sperling_test,
                            needle_mass_in = parameters_all$needle_mass_in,
                            Throughfall = parameters_all$Throughfall,
                            photosynthesis_as_input = FALSE,
                            preles = TRUE)

```

```{r}

height = loaded_data$smearII_data$variable %in% c("dominant_height") | 
  loaded_data$smearII_data$variable %in% c("pine height BA weighted mean") |
  loaded_data$smearII_data$variable %in% c("pine height arithmetic mean")

loaded_data$smearII_data[height,]

```

```{r}
date_sim <- as.Date(CASSIA_preles$Growth$day-1, origin = paste0(CASSIA_preles$Growth$year, "-01-01"))
par(mfrow = c(2, 2))
plot(date_sim, CASSIA_preles$Growth$root_growth, ylab = "Root Growth", xlab = "Time")
plot(date_sim, CASSIA_preles$Growth$respiration_growth + CASSIA_preles$Growth$respiration_maintenance, ylab = "Respiration", xlab = "Time")
plot(date_sim, CASSIA_preles$Growth$diameter_growth, ylab = "Diameter Growth", xlab = "Time")
plot(date_sim, CASSIA_preles$Preles$GPP, ylab = "GPP", xlab = "Time")
points(as.Date(smear$Date), smear$GPP_mean, col = "green", pch = "x")
```


## Preles against SPP (short term)

```{r cars}
Hyde_daily_original_plot <- Hyde_daily_original
variables_original <- c("bud", "wall_daily", "needle_daily", "root_daily", "height_daily", "Rg", "Rm", "P") # TODO: check if I want more, and that these are equivalent!
variables_new <- c("bud_growth", "diameter_growth", "needle_growth", "root_growth", "height_growth", "respiration_growth", "respiration_maintenance", "GPP")

plot_comparison(CASSIA_spp, variables_new,
                Hyde_daily_original_plot, variables_original, soil_processes)

plot_sugar_starch_comparison(CASSIA_spp, weather_original$date, loaded_data$original_data, loaded_data$yu_data)

plot(CASSIA_preles$Preles$GPP, col = "black")

CASSIA_preles_plot <- CASSIA_preles
dates <- which(CASSIA_preles$Growth$year %in% 2015:2018)
CASSIA_preles_plot$Growth <- CASSIA_preles$Growth[dates,]
CASSIA_preles_plot$Sugar <- CASSIA_preles$Sugar[dates,]
CASSIA_preles_plot$Preles <- CASSIA_preles$Preles[dates,]

plot_comparison(CASSIA_preles_plot, variables_new,
                Hyde_daily_original_plot, variables_original, FALSE)

plot_sugar_starch_comparison(CASSIA_preles_plot, weather_original$date, loaded_data$original_data, loaded_data$yu_data)
```

## Comparing the ERA5 data with preles

```{r}
date_sim_2015_2018 <- as.Date(CASSIA_preles$Growth$day[CASSIA_preles$Growth$year %in% 2015:2018]-1, 
                              origin = paste0(CASSIA_preles$Growth$year[CASSIA_preles$Growth$year %in% 2015:2018], "-01-01"))
weather_preles_smear <- data.table::fread("~/Documents/CASSIA/data/preles_smear_CASSIA_ready.csv")

Ritika_2015_2018 <- data[substring(data$Date, 1, 4) %in% 2015:2018,]
weather_preles_2015_2018 <- weather_preles[substring(weather_preles$date, 1, 4) %in% 2015:2018,]

preles_par_r <- Rprebasso::PRELES(PAR = Ritika_2015_2018$PAR,
                                  TAir = Ritika_2015_2018$TA_F,
                                  VPD = Ritika_2015_2018$VPD_F...8,
                                  Precip = Ritika_2015_2018$P_F,
                                  CO2 = rep(410, nrow(Ritika_2015_2018)),
                                  fAPAR = rep(0.8, nrow(Ritika_2015_2018)))

plot(date_sim_2015_2018, CASSIA_spp$Preles$GPP[CASSIA_spp$Growth$year %in% 2015:2018], col = "blue", ylab = "Photosynthesis", xlab = "Date", pch = "x")
points(as.Date(smear$Date), smear$GPP_mean, col = "green", pch = "x")
points(date_sim_2015_2018, CASSIA_preles$Preles$GPP[CASSIA_preles$Growth$year %in% 2015:2018], col = "black", pch = "x")
points(date_sim_2015_2018[-1461], preles_par_r$GPP, col = "red", pch = "x")

```

## Preles and Phydro long term

```{r pressure, echo=FALSE}
new_parameters <- rep(0.5, 27)  # Example new parameters
  calibration = F
  parameters_all <- initialize_parameters(calibration, new_parameters)

  data.direct = "/home/josimms/Documents/CASSIA/data/"
  phydro <- data.table::fread(paste0(data.direct, "ERA5_CASSIA_preles.csv"))
  preles <- data.table::fread(paste0(data.direct, "ERA5_CASSIA_phydro.csv"))
  names(preles)[1] <- "date"

  smear_preles <- CASSIA_cpp(weather = weather_preles,
                             site = "Hyde",
                             pPREL = c(parameters_all$pPREL, parameters_all$N_parameters),
                             parameters = parameters_all$parameters_test,
                             common = common_p,
                             ratios = ratios_p,
                             sperling = parameters_all$sperling_test,
                             needle_mass_in = parameters_all$needle_mass_in,
                             Throughfall = parameters_all$Throughfall,
                             photosynthesis_as_input = FALSE,
                             preles = TRUE)

  # TODO: add into the parameters all formulation
  phydro_parameters_in = c(0.1008, 0.180496537959982, 5, 0.026263945805926, 0.011, 50,
                           0.5, -0.857817410110663, 4.1311874912949e17, 1, 2.45e-2, 2.0, 1.1, 0.1,
                           15, 10, 5, 0, 1, exp(-0.5 * 1.8), exp(-0.5 * 3.5), exp(-0.5 * 5.5))

  smear_phydro <- CASSIA_cpp(weather = phydro,
                             site = "Hyde",
                             pPREL = c(parameters_all$pPREL, parameters_all$N_parameters),
                             parameters = parameters_all$parameters_test,
                             common = common_p,
                             ratios = ratios_p,
                             sperling = parameters_all$sperling_test,
                             needle_mass_in = parameters_all$needle_mass_in,
                             phydro_param = phydro_parameters_in,
                             Throughfall = parameters_all$Throughfall,
                             photosynthesis_as_input = FALSE,
                             ecoevolutionary = TRUE,
                             phydro = TRUE)

  par(mfrow = c(3, 1))
  plot(smear_preles$Preles$GPP, xlab = "Days since 2018-01-01", ylab = "Photosynthesis", col = "blue")
  points(smear_phydro$Preles$GPP, col = "green")

  plot(smear_preles$Growth$diameter_growth, xlab = "Days since 2018-01-01", ylab = "Diameter, kg C", col = "blue")
  points(smear_phydro$Growth$diameter_growth, col = "green")

  plot(smear_preles$Growth$root_growth, xlab = "Days since 2018-01-01", ylab = "Root, kg C", col = "blue")
  points(smear_phydro$Growth$root_growth, col = "green")

```

